<!DOCTYPE html>
<html>
<head>
  <title>Target Scoring System</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    .controls-panel {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .controls-row {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .control-group {
      display: flex;
      gap: 5px;
      align-items: center;
      background: #0a0a0a;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #444;
    }
    .control-label {
      font-size: 12px;
      color: #888;
      font-weight: 700;
      text-transform: uppercase;
      margin-right: 8px;
    }
    .control-value {
      font-size: 14px;
      color: #c5a000;
      font-weight: 700;
      min-width: 60px;
    }
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      background: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-small:hover {
      background: #333;
      border-color: #666;
    }
    .btn-small.active {
      background: #4CAF50;
      border-color: #4CAF50;
    }
    .camera-select {
      background: #000;
      color: #c5a000;
      border: 1px solid #444;
      padding: 6px 10px;
      border-radius: 4px;
      font-weight: 700;
      cursor: pointer;
    }
    .slider {
      width: 150px;
    }
    .collapsible-header {
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .collapsible-header:hover {
      color: #c5a000;
    }
    .collapse-icon {
      transition: transform 0.3s;
    }
    .collapsed .collapse-icon {
      transform: rotate(-90deg);
    }
    .collapsible-content {
      max-height: 500px;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .collapsed .collapsible-content {
      max-height: 0;
    }
  </style>
</head>
<body>

<div class="header">
  <h1>üéØ Electronic Target Scoring</h1>
  <div>
    <button class="btn btn-gold" onclick="toggle()">Start / Stop</button>
    <button class="btn btn-red" onclick="reset()">Reset</button>
    <button class="btn btn-gold" onclick="fetch('/toggle_heatmap')">Heatmap</button>
    <a href="/spectator_fullscreen" class="btn">Spectator</a>
    <a href="/calibrate" class="btn">Calibrate</a>
    <a href="/settings" class="btn">Settings</a>
  </div>
</div>

<div class="main">

  <!-- CAMERA CONTROLS -->
  <div class="controls-panel" id="cameraControls">
    <div class="collapsible-header" onclick="toggleCollapse(this)">
      <span style="font-weight: 700; font-size: 14px;">üìπ CAMERA CONTROLS</span>
      <span class="collapse-icon">‚ñº</span>
    </div>
    <div class="collapsible-content">
      <!-- Camera Selection -->
      <div class="controls-row">
        <div class="control-group">
          <span class="control-label">Camera:</span>
          <select id="cameraSelect" class="camera-select" onchange="changeCamera()">
            <option value="0">Camera 0 (Lane 1)</option>
          </select>
        </div>
      </div>

      <!-- Zoom Controls -->
      <div class="controls-row">
        <div class="control-group">
          <span class="control-label">Zoom:</span>
          <button class="btn-small" onclick="adjustZoom(-0.1)">‚àí</button>
          <span class="control-value" id="zoomValue">1.0x</span>
          <button class="btn-small" onclick="adjustZoom(0.1)">+</button>
          <input type="range" id="zoomSlider" class="slider" min="1.0" max="4.0" step="0.1" value="1.0" oninput="setZoom(this.value)">
          <button class="btn-small" onclick="setZoom(1.0)">Reset</button>
        </div>
      </div>

      <!-- Rotation Controls -->
      <div class="controls-row">
        <div class="control-group">
          <span class="control-label">Rotation:</span>
          <button class="btn-small" onclick="setRotation(0)">0¬∞</button>
          <button class="btn-small" onclick="setRotation(90)">90¬∞</button>
          <button class="btn-small" onclick="setRotation(180)">180¬∞</button>
          <button class="btn-small" onclick="setRotation(270)">270¬∞</button>
          <span class="control-value" id="rotationValue">0¬∞</span>
        </div>
      </div>

      <!-- Exposure & White Balance -->
      <div class="controls-row">
        <div class="control-group">
          <span class="control-label">Exposure:</span>
          <button class="btn-small" id="exposureBtn" onclick="toggleExposure()">Lock</button>
        </div>
        
        <div class="control-group">
          <span class="control-label">White Balance:</span>
          <button class="btn-small" id="wbBtn" onclick="toggleWB()">Auto</button>
          <button class="btn-small" onclick="setWBTemp(2800)">2800K</button>
          <button class="btn-small" onclick="setWBTemp(4000)">4000K</button>
          <button class="btn-small" onclick="setWBTemp(5500)">5500K</button>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="controls-row">
        <button class="btn-small" onclick="optimizeCamera()">‚öôÔ∏è Optimize Camera</button>
        <button class="btn-small" onclick="lockAllSettings()">üîí Lock All Settings</button>
        <button class="btn-small" onclick="showCameraInfo()">‚ÑπÔ∏è Camera Info</button>
      </div>
    </div>
  </div>

  <!-- CAMERA -->
  <div class="panel">
    <div class="panel-title">Live Target Feed</div>
    <div class="viewport">
      <img id="videoFeed" src="/video/0">
    </div>
    <div id="status" class="status inactive">Detection stopped</div>
  </div>

  <!-- SCORE -->
  <div class="panel score-box">
    <div class="panel-title">Scoring</div>

    <div id="total" class="score-total">0</div>

    <div id="hits" class="hit-log"></div>
  </div>

</div>

<script>
let currentCamera = 0;
let exposureLocked = false;
let wbLocked = false;

// Initialize
window.onload = function() {
  loadCameraSettings();
  setInterval(refreshHits, 500);
};

// ========== Detection Controls ==========

async function toggle() {
  const r = await fetch("/toggle");
  const j = await r.json();
  const s = document.getElementById("status");
  s.textContent = j.active ? "Detection running" : "Detection stopped";
  s.className = "status " + (j.active ? "active" : "inactive");
}

async function reset() {
  await fetch("/reset");
  document.getElementById("hits").innerHTML = "";
  document.getElementById("total").textContent = "0";
}

async function refreshHits() {
  const r = await fetch("/hits");
  const hits = await r.json();

  const log = document.getElementById("hits");
  log.innerHTML = "";

  let total = 0;
  hits.forEach(h => {
    const s = document.createElement("span");
    s.textContent = h.score;
    s.style.color = h.score >= 5 ? "#4f8" : h.score > 0 ? "#fa4" : "#f44";
    log.appendChild(s);
    total += h.score;
  });

  document.getElementById("total").textContent = total;
}

// ========== Camera Selection ==========

function changeCamera() {
  currentCamera = parseInt(document.getElementById('cameraSelect').value);
  document.getElementById('videoFeed').src = `/video/${currentCamera}`;
  loadCameraSettings();
}

async function loadCameraSettings() {
  try {
    const response = await fetch(`/camera_info/${currentCamera}`);
    const data = await response.json();
    
    // Update displays
    document.getElementById('zoomValue').textContent = (data.zoom || 1.0).toFixed(1) + 'x';
    document.getElementById('zoomSlider').value = data.zoom || 1.0;
    document.getElementById('rotationValue').textContent = (data.rotation || 0) + '¬∞';
    
    exposureLocked = data.exposure_locked || false;
    document.getElementById('exposureBtn').textContent = exposureLocked ? 'Locked' : 'Lock';
    document.getElementById('exposureBtn').classList.toggle('active', exposureLocked);
    
    wbLocked = data.white_balance_locked || false;
    document.getElementById('wbBtn').textContent = wbLocked ? 'Locked' : 'Auto';
    document.getElementById('wbBtn').classList.toggle('active', wbLocked);
  } catch (err) {
    console.error('Failed to load camera settings:', err);
  }
}

// ========== Zoom Controls ==========

async function adjustZoom(delta) {
  const response = await fetch(`/adjust_zoom/${currentCamera}/${delta}`);
  const data = await response.json();
  document.getElementById('zoomValue').textContent = data.zoom.toFixed(1) + 'x';
  document.getElementById('zoomSlider').value = data.zoom;
}

async function setZoom(value) {
  const response = await fetch(`/set_zoom/${currentCamera}/${value}`);
  const data = await response.json();
  document.getElementById('zoomValue').textContent = data.zoom.toFixed(1) + 'x';
  document.getElementById('zoomSlider').value = data.zoom;
}

// ========== Rotation Controls ==========

async function setRotation(angle) {
  const response = await fetch(`/set_rotation/${currentCamera}/${angle}`);
  const data = await response.json();
  document.getElementById('rotationValue').textContent = data.rotation + '¬∞';
}

// ========== Exposure Control ==========

async function toggleExposure() {
  const endpoint = exposureLocked ? '/unlock_exposure/' : '/lock_exposure/';
  const response = await fetch(endpoint + currentCamera);
  const data = await response.json();
  
  exposureLocked = data.locked;
  document.getElementById('exposureBtn').textContent = exposureLocked ? 'Locked' : 'Lock';
  document.getElementById('exposureBtn').classList.toggle('active', exposureLocked);
}

// ========== White Balance Control ==========

async function toggleWB() {
  const endpoint = wbLocked ? '/unlock_white_balance/' : '/lock_white_balance/';
  const response = await fetch(endpoint + currentCamera);
  const data = await response.json();
  
  wbLocked = data.locked;
  document.getElementById('wbBtn').textContent = wbLocked ? 'Locked' : 'Auto';
  document.getElementById('wbBtn').classList.toggle('active', wbLocked);
}

async function setWBTemp(temp) {
  // First lock WB if not locked
  if (!wbLocked) {
    await fetch(`/lock_white_balance/${currentCamera}`);
    wbLocked = true;
    document.getElementById('wbBtn').textContent = 'Locked';
    document.getElementById('wbBtn').classList.add('active');
  }
  
  // Then set temperature
  await fetch(`/set_white_balance/${currentCamera}/${temp}`);
}

// ========== Quick Actions ==========

async function optimizeCamera() {
  await fetch(`/optimize_camera/${currentCamera}`);
  alert('Camera optimized for detection');
}

async function lockAllSettings() {
  // Lock exposure
  if (!exposureLocked) {
    await fetch(`/lock_exposure/${currentCamera}`);
  }
  
  // Lock white balance
  if (!wbLocked) {
    await fetch(`/lock_white_balance/${currentCamera}`);
  }
  
  loadCameraSettings();
  alert('All camera settings locked');
}

async function showCameraInfo() {
  const response = await fetch(`/camera_info/${currentCamera}`);
  const data = await response.json();
  
  const info = `Camera ${currentCamera} Info:
  
Resolution: ${data.width}x${data.height}
FPS: ${data.fps}
Zoom: ${data.zoom.toFixed(1)}x
Rotation: ${data.rotation}¬∞
Exposure: ${data.exposure} (${data.exposure_locked ? 'Locked' : 'Auto'})
White Balance: ${data.white_balance}K (${data.white_balance_locked ? 'Locked' : 'Auto'})
Brightness: ${data.brightness}
Contrast: ${data.contrast}`;
  
  alert(info);
}

// ========== UI Helpers ==========

function toggleCollapse(header) {
  header.parentElement.classList.toggle('collapsed');
}

// Auto-collapse camera controls after 5 seconds
setTimeout(() => {
  const controls = document.getElementById('cameraControls');
  controls.classList.add('collapsed');
}, 5000);
</script>

</body>
</html>
